<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Behavior Tracker Admin (DataTables)</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // Format Firestore timestamps
    function formatTimestamp(ts) {
      try {
        if (!ts) return "";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        if (ts instanceof Date) return ts.toLocaleString();
        return String(ts);
      } catch { return ""; }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyClJy0GHBpDHSy4b5pKM0B9bNsMHa7pxAI",
      authDomain: "behavior-database.firebaseapp.com",
      projectId: "behavior-database",
      storageBucket: "behavior-database.firebasestorage.app",
      messagingSenderId: "350774293300",
      appId: "1:350774293300:web:44e06673ae52421375eb61"
    };
    const ADMIN_EMAIL = "dramatwinsmoviereels@gmail.com";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let dataTable;

    window.signIn = async () => {
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (err) { alert('Sign-in failed: ' + err.message); }
    };
    window.signOutAdmin = async () => { await signOut(auth); };

    onAuthStateChanged(auth, async user => {
      if (user?.email === ADMIN_EMAIL) {
        $('#adminPanel').show();
        $('#loginPanel').hide();
        await loadAdminEntries();
      } else {
        $('#adminPanel').hide();
        $('#loginPanel').show();
      }
    });

    async function loadAdminEntries() {
      const snaps = await getDocs(collection(db, 'entries'));
      const bannedSnap = await getDocs(collection(db, 'bannedIps'));
      const banned = {};
      bannedSnap.forEach(d => banned[d.id] = true);

      const rows = [];
      snaps.forEach(docSnap => {
        const e = docSnap.data();
        const ip = e.ip || '';
        const isBanned = ip && banned[ip];
        rows.push([
          e.date||'',
          e.platform||'',
          e.behavior||'',
          e.target||'',
          e.summary||'',
          `<a href="${e.evidence||''}" target="_blank">Link</a>`,
          formatTimestamp(e.timestamp_server)||e.timestamp||'',
          e.status||'',
          ip,
          e.country||'',
          e.region||'',
          e.city||'',
          ip ? (isBanned
            ? `<button class="dt-btn" onclick="unbanIp('${ip}')">Unban</button>`
            : `<button class="dt-btn" onclick="banIp('${ip}')">Ban</button>`) : '',
          `<button class="dt-btn" onclick="deleteEntry('${docSnap.id}')">Delete</button>`
        ]);
      });

      if ($.fn.dataTable.isDataTable('#adminDataTable')) {
        dataTable.clear().rows.add(rows).draw();
      } else {
        dataTable = $('#adminDataTable').DataTable({
          data: rows,
          columns: [
            { title: 'Date' },{ title:'Platform' },{ title:'Behavior' },{ title:'Target' },{ title:'Summary' },
            { title:'Evidence' },{ title:'Timestamp' },{ title:'Status' },{ title:'IP' },{ title:'Country' },
            { title:'Region' },{ title:'City' },{ title:'Ban/Unban', orderable:false },{ title:'Delete', orderable:false }
          ],
          scrollX: true,
          pageLength: 10,
          responsive: true
        });
      }
    }

    window.banIp = async ip => { await setDoc(doc(db,'bannedIps',ip),{banned:true}); loadAdminEntries(); };
    window.unbanIp = async ip => { await deleteDoc(doc(db,'bannedIps',ip)); loadAdminEntries(); };
    window.deleteEntry = async id => { if (confirm('Delete this entry?')) { await deleteDoc(doc(db,'entries',id)); loadAdminEntries(); }};
  </script>
  <style>
    body { font-family:sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .panel { background:#fff; padding:20px; margin:auto; max-width:1200px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    #loginPanel button, #adminPanel button.dt-btn { margin:0 4px; }
    #adminPanel { display:none; }
    #adminPanel .right { float:right; }
  </style>
</head>
<body>
  <div id="loginPanel" class="panel"><h2>Admin Sign-In</h2><button onclick="signIn()">Sign in with Google</button></div>
  <div id="adminPanel" class="panel">
    <h2>Behavior Tracker Admin</h2><button class="right" onclick="signOutAdmin()">Sign Out</button>
    <table id="adminDataTable" class="display" style="width:100%"></table>
  </div>
</body>
</html>
