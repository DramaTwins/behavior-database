<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Behavior Tracker Admin (DataTables)</title>
  <!-- Roboto Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tabler Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.6.0/tabler-icons.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    function formatTimestamp(ts) {
      try {
        if (!ts) return "";
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString();
        if (ts instanceof Date) return ts.toLocaleString();
        return String(ts);
      } catch { return ""; }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyClJy0GHBpDHSy4b5pKM0B9bNsMHa7pxAI",
      authDomain: "behavior-database.firebaseapp.com",
      projectId: "behavior-database",
      storageBucket: "behavior-database.firebasestorage.app",
      messagingSenderId: "350774293300",
      appId: "1:350774293300:web:44e06673ae52421375eb61"
    };
    const ADMIN_EMAIL = "dramatwinsmoviereels@gmail.com";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let dataTable;

    window.signIn = async () => {
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (err) { alert('Sign-in failed: ' + err.message); }
    };
    window.signOutAdmin = async () => { await signOut(auth); };

    onAuthStateChanged(auth, async user => {
      if (user?.email === ADMIN_EMAIL) {
        $('#adminPanel').show();
        $('#loginPanel').hide();
        await loadAdminEntries();
      } else {
        $('#adminPanel').hide();
        $('#loginPanel').show();
      }
    });

    async function loadAdminEntries() {
      const snaps = await getDocs(collection(db, 'entries'));
      const bannedSnap = await getDocs(collection(db, 'bannedIps'));
      const banned = {};
      bannedSnap.forEach(d => banned[d.id] = true);

      const rows = [];
      snaps.forEach(docSnap => {
        const e = docSnap.data();
        const ip = e.ip || '';
        const isBanned = ip && banned[ip];
        // Use timestamp_server for sorting, display formatted
        let rawTimestamp = '';
        let displayTimestamp = '';
        if (e.timestamp_server && typeof e.timestamp_server.toDate === 'function') {
          rawTimestamp = e.timestamp_server.toDate().getTime();
          displayTimestamp = e.timestamp_server.toDate().toLocaleString();
        } else if (e.timestamp_server && typeof e.timestamp_server === 'number') {
          rawTimestamp = e.timestamp_server;
          displayTimestamp = new Date(e.timestamp_server).toLocaleString();
        } else if (e.timestamp) {
          rawTimestamp = e.timestamp;
          displayTimestamp = e.timestamp;
        }
        rows.push([
          e.date||'',
          e.platform||'',
          e.behavior||'',
          e.target||'',
          e.summary||'',
          `<a href="${e.evidence||''}" target="_blank">Link</a>`,
          e.timestamp||'', // Video timestamp from form
          rawTimestamp, // for sorting
          displayTimestamp, // for display (hidden column)
          e.status||'',
          ip,
          e.country||'',
          e.region||'',
          e.city||'',
          ip ? (isBanned
            ? `<button class="dt-btn ban" onclick="unbanIp('${ip}')"><i class='ti ti-user-check'></i> Unban</button>`
            : `<button class="dt-btn ban" onclick="banIp('${ip}')"><i class='ti ti-user-x'></i> Ban</button>`) : '',
          `<button class="dt-btn delete" onclick="deleteEntry('${docSnap.id}')"><i class='ti ti-trash'></i> Delete</button>`
        ]);
      });

      if ($.fn.dataTable.isDataTable('#adminDataTable')) {
        dataTable.clear().rows.add(rows).draw();
      } else {
        dataTable = $('#adminDataTable').DataTable({
          data: rows,
          columns: [
            { title: 'Date' },{ title:'Platform' },{ title:'Behavior' },{ title:'Target' },{ title:'Summary' },
            { title:'Evidence' },
            { title:'Video Timestamp' },
            { title:'Timestamp', visible:false }, // raw timestamp, hidden
            { title:'Date Entered' }, // display formatted timestamp
            { title:'Status' },{ title:'IP' },{ title:'Country' },{ title:'Region' },{ title:'City' },{ title:'Ban/Unban', orderable:false },{ title:'Delete', orderable:false }
          ],
          order: [[7, 'desc']], // sort by raw timestamp (date entered)
          columnDefs: [
            { targets: 7, visible: false }, // hide raw timestamp column
            { targets: 8, orderData: 7 } // sort display column by raw timestamp
          ],
          scrollX: true,
          pageLength: 10,
          responsive: true
        });
      }
    }

    window.banIp = async ip => { await setDoc(doc(db,'bannedIps',ip),{banned:true}); loadAdminEntries(); };
    window.unbanIp = async ip => { await deleteDoc(doc(db,'bannedIps',ip)); loadAdminEntries(); };
    window.deleteEntry = async id => { if (confirm('Delete this entry?')) { await deleteDoc(doc(db,'entries',id)); loadAdminEntries(); }};
  </script>
  <style>
    body { font-family: 'Roboto', sans-serif; background: linear-gradient(120deg,#f7fafc,#e3e6ee 55%,#f7fafc 100%); color: #222; margin:0; min-height:100vh; transition: background .4s, color .4s; }
    .header-bar { display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, #43cea2 0, #185a9d 100%); color: #fff; padding: 18px 0 12px 0; border-radius: 0 0 18px 18px; box-shadow: 0 2px 12px rgba(36,41,46,.08); margin-bottom: 24px; }
    .header-bar .logo { font-size: 2.2rem; margin-right: 12px; }
    .header-bar h1 { margin: 0; font-size: 2rem; font-weight: 700; letter-spacing: 1px; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(36,41,46,.10); padding: 24px 18px; margin-bottom: 32px; transition: background .3s, color .3s; max-width: 1200px; margin-left: auto; margin-right: auto; }
    .login-card { max-width: 400px; margin: 40px auto 0 auto; }
    .admin-card { margin-top: 0; }
    .right { float: right; }
    .btn, .dt-btn { padding: 10px 22px; border-radius: 999px; font-weight: 600; font-size: 1rem; box-shadow: 0 2px 8px rgba(36,41,46,.08); background: linear-gradient(90deg,#43cea2 0,#185a9d 100%); color: white; border: none; cursor:pointer; transition: background .3s, transform .2s; display: inline-flex; align-items: center; gap: 8px; margin: 0 4px; }
    .btn:hover, .dt-btn:hover { background: linear-gradient(90deg,#185a9d 0,#43cea2 100%); }
    .btn:active, .dt-btn:active { transform: scale(0.97); }
    .dt-btn.delete { background: linear-gradient(90deg,#e53935 0,#b71c1c 100%); }
    .dt-btn.delete:hover { background: linear-gradient(90deg,#b71c1c 0,#e53935 100%); }
    .dt-btn.ban { background: linear-gradient(90deg,#ffb300 0,#ff7043 100%); color: #222; }
    .dt-btn.ban:hover { background: linear-gradient(90deg,#ff7043 0,#ffb300 100%); }
    .panel { background: none; box-shadow: none; padding: 0; margin: 0; border-radius: 0; }
    #loginPanel, #adminPanel { display: none; }
    #loginPanel.active, #adminPanel.active { display: block; }
    #adminPanel .right { float:right; }
    .dataTable-card { overflow-x: auto; }
    table.dataTable { width: 100% !important; table-layout: auto; border-radius: 12px; overflow: hidden; background: transparent; margin-top: 18px; }
    table.dataTable thead { background: #f7fafc; }
    table.dataTable tbody tr:hover { background: #e3e6ee; transition: background .2s; }
    th, td { padding: 13px 14px; }
    @media (max-width: 700px) {
      .header-bar { flex-direction: column; padding: 12px 0; }
      .card { padding: 10px 2vw; }
      th, td { padding: 10px 4px; }
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <span class="logo"><i class="ti ti-shield-lock"></i></span>
    <h1>Behavior Tracker Admin</h1>
  </div>
  <div id="loginPanel" class="card login-card active">
    <h2 style="text-align:center;">Admin Sign-In</h2>
    <button class="btn" onclick="signIn()"><i class="ti ti-brand-google"></i> Sign in with Google</button>
  </div>
  <div id="adminPanel" class="card admin-card">
    <button class="btn right" onclick="signOutAdmin()"><i class="ti ti-logout"></i> Sign Out</button>
    <h2 style="margin-top:0;">Admin Dashboard</h2>
    <div class="dataTable-card">
      <table id="adminDataTable" class="display" style="width:100%"></table>
    </div>
  </div>
  <script>
    // Show/hide panels based on class for fade-in effect
    function showPanel(panelId) {
      document.getElementById('loginPanel').classList.remove('active');
      document.getElementById('adminPanel').classList.remove('active');
      document.getElementById(panelId).classList.add('active');
    }
    // Listen for auth state changes to show correct panel
    window.addEventListener('DOMContentLoaded', function() {
      // The module script will handle showing/hiding
    });
  </script>
</body>
</html>
