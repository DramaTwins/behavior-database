<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Behavior Tracker</title>
  <!-- Roboto Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tabler Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.6.0/tabler-icons.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; background: linear-gradient(120deg,#f7fafc,#e3e6ee 55%,#f7fafc 100%); color: #222; transition: background .4s, color .4s; }
    body.dark { background: linear-gradient(120deg,#232526,#28292d 55%,#232526 100%); color: #e0e0e0; }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 12px; }
    /* Header Bar */
    .header-bar { display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, #43cea2 0, #185a9d 100%); color: #fff; padding: 18px 0 12px 0; border-radius: 0 0 18px 18px; box-shadow: 0 2px 12px rgba(36,41,46,.08); margin-bottom: 24px; }
    .header-bar .logo { font-size: 2.2rem; margin-right: 12px; }
    .header-bar h1 { margin: 0; font-size: 2rem; font-weight: 700; letter-spacing: 1px; }
    /* Card Layout */
    .card { background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(36,41,46,.10); padding: 24px 18px; margin-bottom: 32px; transition: background .3s, color .3s; }
    body.dark .card { background: #232323; color: #f0f0f0; }
    /* Button Enhancements */
    .button-wrapper { text-align: center; margin-bottom: 20px; }
    .button-wrapper button { padding: 12px 28px; border-radius: 999px; font-weight: 600; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(36,41,46,.08); background: linear-gradient(90deg,#43cea2 0,#185a9d 100%); color: white; border: none; cursor:pointer; transition: background .3s, transform .2s; display: inline-flex; align-items: center; gap: 8px; }
    .button-wrapper button:hover { background: linear-gradient(90deg,#185a9d 0,#43cea2 100%); }
    .button-wrapper button:active { transform: scale(0.97); }
    /* Filter Wrapper */
    .filter-wrapper { text-align: center; margin-bottom: 16px; }
    .filter-wrapper select { padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc; }
    /* DataTable Card */
    .dataTable-card { overflow-x: auto; }
    table.dataTable { width: 100% !important; table-layout: auto; border-radius: 12px; overflow: hidden; background: transparent; }
    table.dataTable thead { background: #f7fafc; }
    body.dark table.dataTable thead { background: #232526; }
    table.dataTable tbody tr:hover { background: #e3e6ee; transition: background .2s; }
    body.dark table.dataTable tbody tr:hover { background: #292a35; }
    /* Submission Form Styles */
    form#incidentForm { background: transparent; border-radius: 12px; box-shadow: none; max-width: 600px; margin: 32px auto; padding: 18px 16px; border: none; }
    body.dark form#incidentForm { background: transparent; color: #f0f0f0; border-color: #292a35; }
    form#incidentForm label { display:block; font-weight:500; margin-bottom:4px; }
    form#incidentForm input, form#incidentForm select, form#incidentForm textarea { width:100%; padding:7px 8px; margin:4px 0 12px; border-radius:6px; border:1px solid #bdbdbd; background:#f8fafd; transition: border-color .2s, box-shadow .2s, background .2s; }
    body.dark form#incidentForm input, body.dark form#incidentForm select, body.dark form#incidentForm textarea { background:#232323; color:#f0f0f0; border:1px solid #444; }
    form#incidentForm input:focus, form#incidentForm select:focus, form#incidentForm textarea:focus { border-color: #43cea2; outline: none; box-shadow: 0 0 0 2px #43cea233; background: #f0f8f7; }
    body.dark form#incidentForm input:focus, body.dark form#incidentForm select:focus, body.dark form#incidentForm textarea:focus { background: #232a2a; border-color: #43cea2; }
    form#incidentForm button { display:block; margin:10px auto 0; padding:12px 28px; background:linear-gradient(90deg,#43cea2 0,#185a9d 100%); color:white; border:none; border-radius:999px; cursor:pointer; font-weight:600; font-size:1.1rem; box-shadow: 0 2px 8px rgba(36,41,46,.08); transition: background .3s, transform .2s; }
    form#incidentForm button:hover { background:linear-gradient(90deg,#185a9d 0,#43cea2 100%); }
    form#incidentForm button:active { transform: scale(0.97); }
    @media (max-width: 700px) { 
      .header-bar { flex-direction: column; padding: 12px 0; }
      .card { padding: 10px 2vw; }
      form#incidentForm { padding: 8px 1vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-bar">
      <span class="logo"><i class="ti ti-brain"></i></span>
      <h1>Documented Behavior Database</h1>
    </div>
    <div class="card">
      <div class="button-wrapper">
        <button onclick="toggleDarkMode()"><i class="ti ti-moon"></i> Toggle Dark Mode</button>
      </div>
      <div class="filter-wrapper">
        <label for="behaviorFilter">Filter Behavior:</label>
        <select id="behaviorFilter">
          <option value="">All</option>
          <option value="Gaslighting">Gaslighting</option>
          <option value="Smear Campaign">Smear Campaign</option>
          <option value="Love Bombing & Devaluation">Love Bombing & Devaluation</option>
          <option value="Contradictory Statements">Contradictory Statements</option>
          <option value="Victim Playing">Victim Playing</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="dataTable-card">
        <table id="dataTable" class="display nowrap"></table>
      </div>
    </div>
    <!-- Submission Form -->
    <div class="card">
      <form id="incidentForm" onsubmit="submitHandler(event)">
        <h2 style="text-align:center">Submit New Behavior</h2>
        <label>Date:<input type="date" id="newDate" required></label>
        <label>Platform:<select id="newPlatform" required>
          <option value="">Select Platform</option>
          <option value="TikTok">TikTok</option>
          <option value="Instagram">Instagram</option>
          <option value="YouTube">YouTube</option>
          <option value="Discord">Discord</option>
          <option value="Facebook">Facebook</option>
          <option value="Other">Other</option>
        </select></label>
        <label>Behavior:<select id="newBehavior" required>
          <option value="">Select Behavior</option>
          <option value="Gaslighting">Gaslighting</option>
          <option value="Smear Campaign">Smear Campaign</option>
          <option value="Love Bombing & Devaluation">Love Bombing & Devaluation</option>
          <option value="Contradictory Statements">Contradictory Statements</option>
          <option value="Victim Playing">Victim Playing</option>
          <option value="Other">Other</option>
        </select></label>
        <label>Target:<input type="text" id="newTarget" required></label>
        <label>Summary:<textarea id="newSummary" rows="3" required></textarea></label>
        <label>Evidence (URL):<input type="url" id="newEvidence" required placeholder="https://"></label>
        <label>Video Timestamp (optional):<input type="text" id="newTimestamp" placeholder="e.g. 13:42"></label>
        <label>Status:<select id="newStatus" required>
          <option value="Documented">Documented</option>
          <option value="Deleted Post">Deleted Post</option>
          <option value="Ongoing">Ongoing</option>
        </select></label>
        <button type="submit"><i class="ti ti-send"></i> Submit</button>
      </form>
    </div>
  </div>
  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClJy0GHBpDHSy4b5pKM0B9bNsMHa7pxAI",
      authDomain: "behavior-database.firebaseapp.com",
      projectId: "behavior-database",
      storageBucket: "behavior-database.firebasestorage.app",
      messagingSenderId: "350774293300",
      appId: "1:350774293300:web:44e06673ae52421375eb61"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function formatTimestamp(ts) {
      return ts ? ts.toString() : '';
    }

    let table;
    async function loadEntries() {
      const filter = document.getElementById('behaviorFilter').value;
      const snaps = await getDocs(collection(db, "entries"));
      const data = [];
      snaps.docs.forEach(docSnap => {
        const e = docSnap.data();
        if (filter && e.behavior !== filter) return;
        const icons = {TikTok:'<i class="ti ti-brand-tiktok"></i>',Instagram:'<i class="ti ti-brand-instagram"></i>',YouTube:'<i class="ti ti-brand-youtube"></i>',Discord:'<i class="ti ti-brand-discord"></i>',Facebook:'<i class="ti ti-brand-facebook"></i>'};
        const icon = icons[e.platform] || '<i class="ti ti-dots"></i>';
        // Use timestamp_server for sorting, display formatted
        let rawTimestamp = '';
        let displayTimestamp = '';
        if (e.timestamp_server && typeof e.timestamp_server.toDate === 'function') {
          rawTimestamp = e.timestamp_server.toDate().getTime();
          displayTimestamp = e.timestamp_server.toDate().toLocaleString();
        } else if (e.timestamp_server && typeof e.timestamp_server === 'number') {
          rawTimestamp = e.timestamp_server;
          displayTimestamp = new Date(e.timestamp_server).toLocaleString();
        } else if (e.timestamp) {
          // fallback to existing timestamp
          rawTimestamp = e.timestamp;
          displayTimestamp = e.timestamp;
        }
        data.push([
          e.date||'',
          icon+ ' ' + (e.platform||''),
          e.behavior||'',
          e.target||'',
          e.summary||'',
          `<a href="${e.evidence||''}" target="_blank">Link</a>`,
          rawTimestamp, // for sorting
          displayTimestamp, // for display (hidden column)
          e.status||''
        ]);
      });
      if (table) {
        table.clear().rows.add(data).draw();
      } else {
        table = $('#dataTable').DataTable({
          data,
          destroy: true,
          order: [[6, 'desc']], // sort by timestamp_server (rawTimestamp)
          columns: [
            { title: 'Date' },
            { title: 'Platform' },
            { title: 'Behavior' },
            { title: 'Target' },
            { title: 'Summary' },
            { title: 'Evidence', className: 'dt-center' },
            { title: 'Timestamp', visible: false }, // raw timestamp, hidden
            { title: 'Date Entered' }, // display formatted timestamp
            { title: 'Status' }
          ],
          columnDefs: [
            { targets: 6, visible: false }, // hide raw timestamp column
            { targets: 7, orderData: 6 } // sort display column by raw timestamp
          ],
          scrollX: true,
          pageLength: 10
        });
      }
    }

    document.getElementById('behaviorFilter').addEventListener('change', loadEntries);
    window.onload = loadEntries;
    window.toggleDarkMode = () => document.body.classList.toggle('dark');

    window.submitHandler = async function(e) {
      e.preventDefault();
      const newEntry = {
        date: document.getElementById("newDate").value,
        platform: document.getElementById("newPlatform").value,
        behavior: document.getElementById("newBehavior").value,
        target: document.getElementById("newTarget").value,
        summary: document.getElementById("newSummary").value,
        evidence: document.getElementById("newEvidence").value,
        timestamp: document.getElementById("newTimestamp").value,
        status: document.getElementById("newStatus").value
      };
      try {
        const res = await fetch('https://submitentrywithip-h5rwi5h32q-uc.a.run.app', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(newEntry) });
        const result = await res.json();
        if(result.success) { loadEntries(); document.getElementById('incidentForm').reset(); }
        else alert(result.error||'Error');
      } catch(err) { alert('Network error: '+err.message); }
    };
  </script>
</body>
</html>
