<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Behavior Tracker</title>
  <!-- Roboto Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tabler Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.6.0/tabler-icons.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; background: linear-gradient(120deg,#f7fafc,#e3e6ee 55%,#f7fafc 100%); color: #222; transition: background-color .3s, color .3s; }
    body.dark { background: linear-gradient(120deg,#232526,#28292d 55%,#232526 100%); color: #e0e0e0; }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 12px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .button-wrapper { text-align: center; margin-bottom: 20px; }
    .button-wrapper button { padding: 10px 20px; background: linear-gradient(90deg,#43cea2 0,#185a9d 100%); color: white; border: none; border-radius:5px; cursor:pointer; }
    .button-wrapper button:hover { background: linear-gradient(90deg,#185a9d 0,#43cea2 100%); }
    table.dataTable { width: 100% !important; }
    .dt-center { text-align: center; }
    .ti { font-size:1.3em; vertical-align:middle; margin-right:5px; opacity:.85; }
    /* Submission Form Styles */
    form#incidentForm { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(36,41,46,.10); max-width: 550px; margin: 32px auto; padding: 18px 16px; border: 1.5px solid #e8e9f1; }
    body.dark form#incidentForm { background: #181818; color: #f0f0f0; border-color: #292a35; }
    form#incidentForm label { display:block; font-weight:500; margin-bottom:4px; }
    form#incidentForm input, form#incidentForm select, form#incidentForm textarea { width:100%; padding:7px 8px; margin:4px 0 12px; border-radius:6px; border:1px solid #bdbdbd; background:#f8fafd; }
    body.dark form#incidentForm input, body.dark form#incidentForm select, body.dark form#incidentForm textarea { background:#232323; color:#f0f0f0; border:1px solid #444; }
    form#incidentForm button { display:block; margin:10px auto 0; padding:10px 25px; background:linear-gradient(90deg,#43cea2 0,#185a9d 100%); color:white; border:none; border-radius:8px; cursor:pointer; }
    form#incidentForm button:hover { background:linear-gradient(90deg,#185a9d 0,#43cea2 100%); }
    @media (max-width: 700px) { form#incidentForm { padding: 8px 1vw; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§  Documented Behavior Database</h1>
    <div class="button-wrapper">
      <button onclick="toggleDarkMode()">ðŸŒ™ Toggle Dark Mode</button>
    </div>
    <table id="dataTable" class="display nowrap"></table>
    
    <!-- Submission Form -->
    <form id="incidentForm" onsubmit="submitHandler(event)">
      <h2 style="text-align:center">Submit New Behavior</h2>
      <label>Date:<input type="date" id="newDate" required></label>
      <label>Platform:<select id="newPlatform" required>
        <option value="">Select Platform</option>
        <option value="TikTok">TikTok</option>
        <option value="Instagram">Instagram</option>
        <option value="YouTube">YouTube</option>
        <option value="Discord">Discord</option>
        <option value="Facebook">Facebook</option>
        <option value="Other">Other</option>
      </select></label>
      <label>Behavior:<select id="newBehavior" required>
        <option value="">Select Behavior</option>
        <option value="Gaslighting">Gaslighting</option>
        <option value="Smear Campaign">Smear Campaign</option>
        <option value="Love Bombing & Devaluation">Love Bombing & Devaluation</option>
        <option value="Contradictory Statements">Contradictory Statements</option>
        <option value="Victim Playing">Victim Playing</option>
        <option value="Other">Other</option>
      </select></label>
      <label>Target:<input type="text" id="newTarget" required></label>
      <label>Summary:<textarea id="newSummary" rows="3" required></textarea></label>
      <label>Evidence (URL):<input type="url" id="newEvidence" required placeholder="https://"></label>
      <label>Video Timestamp (optional):<input type="text" id="newTimestamp" placeholder="e.g. 13:42"></label>
      <label>Status:<select id="newStatus" required>
        <option value="Documented">Documented</option>
        <option value="Deleted Post">Deleted Post</option>
        <option value="Ongoing">Ongoing</option>
      </select></label>
      <button type="submit">Submit</button>
    </form>
  </div>

  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClJy0GHBpDHSy4b5pKM0B9bNsMHa7pxAI",
      authDomain: "behavior-database.firebaseapp.com",
      projectId: "behavior-database",
      storageBucket: "behavior-database.firebasestorage.app",
      messagingSenderId: "350774293300",
      appId: "1:350774293300:web:44e06673ae52421375eb61"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function formatTimestamp(ts) {
      try { if (!ts) return ''; return ts.toString(); } catch { return ''; }
    }

    async function loadEntries() {
      const snaps = await getDocs(collection(db, "entries"));
      const data = snaps.docs.map(docSnap => {
        const e = docSnap.data();
        const icons = {TikTok:'<i class="ti ti-brand-tiktok"></i>',Instagram:'<i class="ti ti-brand-instagram"></i>',YouTube:'<i class="ti ti-brand-youtube"></i>',Discord:'<i class="ti ti-brand-discord"></i>',Facebook:'<i class="ti ti-brand-facebook"></i>'};
        const icon = icons[e.platform] || '<i class="ti ti-dots"></i>';
        return [e.date||'', icon+ ' ' + (e.platform||''), e.behavior||'', e.target||'', e.summary||'', `<a href="${e.evidence||''}" target="_blank">Link</a>`, formatTimestamp(e.timestamp)||'', e.status||''];
      });
      $('#dataTable').DataTable({ data, destroy:true, columns:[{title:'Date'},{title:'Platform'},{title:'Behavior'},{title:'Target'},{title:'Summary'},{title:'Evidence',className:'dt-center'},{title:'Timestamp'},{title:'Status'}], scrollX:true, pageLength:10 });
    }

    window.onload = loadEntries;
    window.toggleDarkMode = () => document.body.classList.toggle('dark');

    window.submitHandler = async function(e) {
      e.preventDefault();
      const newEntry = {
        date: document.getElementById("newDate").value,
        platform: document.getElementById("newPlatform").value,
        behavior: document.getElementById("newBehavior").value,
        target: document.getElementById("newTarget").value,
        summary: document.getElementById("newSummary").value,
        evidence: document.getElementById("newEvidence").value,
        timestamp: document.getElementById("newTimestamp").value,
        status: document.getElementById("newStatus").value
      };
      try {
        const res = await fetch('https://submitentrywithip-h5rwi5h32q-uc.a.run.app', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(newEntry) });
        const result = await res.json();
        if(result.success) { loadEntries(); document.getElementById('incidentForm').reset(); }
        else alert(result.error||'Error');
      } catch(err) { alert('Network error: '+err.message); }
    };
  </script>
</body>
</html>
